---
- name: Add IP to allowed_hosts in nrpe.cfg
  lineinfile:
    path: /usr/local/nagios/etc/nrpe.cfg
    regexp: '^allowed_hosts='
    line: 'allowed_hosts=127.0.0.1,{{ nagios_server_ip }}'

- name: Set dont_blame_nrpe to 1 in nrpe.cfg
  lineinfile:
    path: /usr/local/nagios/etc/nrpe.cfg
    regexp: '^dont_blame_nrpe='
    line: 'dont_blame_nrpe=1'

- name: Update services file with NRPE Service Name, Port and Protocol
  lineinfile:
    path: /etc/services
    line: "nrpe            5666/tcp                # NRPE Service"

- name: Add scripts
  template:
    src: "{{ item }}"
    dest: /usr/local/nagios/libexec/{{ item | basename | regex_replace('\\.j2$', '') }}
    owner: nagios
    group: nagios
    mode: 0755
  loop:
    - check_docker.j2

- name: Add check commands to NRPE config
  lineinfile:
    path: /usr/local/nagios/etc/nrpe.cfg
    line: "{{ item }}"
    insertafter: EOF
    state: present
  loop:
    - command[check_docker]=/bin/bash /usr/local/nagios/libexec/check_docker -c apache-container
    - command[check_docker_httpd]=/bin/bash /usr/local/nagios/libexec/check_docker -c apache-container -s httpd

- name: Disable SSL when running NRPE Agent 
  replace:
    path: /usr/lib/systemd/system/nrpe.service
    regexp: '-f$'
    replace: '-f -n'

- name: Restart NRPE Service
  service:
    name: nrpe
    state: restarted